# Life-OS 更新日志 v2.2

**更新日期**: 2026-02-07
**版本**: v2.2
**类型**: 功能改进 + Bug修复

---

## 🎯 核心改进

### 1. githubService.js 完善改造

#### ✅ 新增功能
- **文件冲突处理**: 先检查文件是否已存在，避免覆盖错误
- **重试机制**: 网络错误时自动重试3次（指数退避）
- **内容大小检查**: 超过1MB时提前报错，避免API失败
- **详细错误分类**:
  - 401: Token无效或过期
  - 403: 权限不足或请求超限
  - 404: 仓库或路径不存在
  - 422: 验证失败
  - 其他: 未知错误

#### ✅ 元数据增强
- 新增 `direction` 字段（内容方向）
- 新增 `url` 字段（原始链接）

#### 🔧 技术细节
```javascript
// 1. 文件存在性检查
const checkResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${fullPath}?ref=${branch}`, {
  headers: { 'Authorization': `token ${token}` }
});
if (checkResponse.ok) {
  sha = existingFile.sha; // 获取文件SHA用于更新
}

// 2. 重试机制
for (let attempt = 1; attempt <= maxRetries; attempt++) {
  try {
    // API调用
  } catch (error) {
    if (attempt === maxRetries) throw error;
    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt - 1)));
  }
}
```

---

### 2. App.jsx Jina Reader 优化

#### ✅ 核心问题修复
- **原始URL保留**: 解决用户反馈的"链接丢失"问题
- **内容长度优化**:
  - 默认: 5000字符
  - 微信/小红书: 8000字符
  - Twitter: 3000字符
- **截断提示**: 超过长度时显示"内容已截断，完整内容请查看原文"

#### ✅ 平台识别
新增7个平台自动识别：
- 微信公众号 (`mp.weixin.qq.com`)
- 小红书 (`xiaohongshu.com`, `xhslink.com`)
- 知乎 (`zhihu.com`)
- Twitter/X (`x.com`, `twitter.com`)
- B站 (`bilibili.com`)
- 抖音 (`douyin.com`)
- 默认网页

#### ✅ 格式优化
抓取内容使用Obsidian callout格式：
```markdown
> [!info] 来源：微信公众号
> https://mp.weixin.qq.com/s/xxxxx

[抓取的内容...]

---
**原始输入**: [用户输入的内容]
```

#### 🔧 技术细节
```javascript
// 1. 平台识别
let platform = "网页";
if (originalUrl.includes('mp.weixin.qq.com')) platform = "微信公众号";
else if (originalUrl.includes('xiaohongshu.com')) platform = "小红书";
// ...

// 2. 内容长度根据平台调整
let maxChars = 5000;
if (platform === "微信公众号" || platform === "小红书") maxChars = 8000;

// 3. 确保URL被保留
if (originalUrl && !result.content.includes('原文链接')) {
  result.content += `\n\n---\n原文链接: ${originalUrl}`;
}
```

---

### 3. handleSend 方法改进

#### ✅ URL传递链路打通
- 从用户输入中提取URL
- 传递给AI优化（Jina抓取）
- AI失败时仍保留URL
- 最终传递给GitHub存储

#### 🔧 技术细节
```javascript
// 1. 提取URL
const urlRegex = /(https?:\/\/[^\s]+)/g;
const urlMatch = (inputValue + " " + (details.note || "")).match(urlRegex);
if (urlMatch && urlMatch.length > 0) {
  originalUrl = urlMatch[0];
}

// 2. 传递给GitHub
await githubService.addRecord({
  title: finalTitle,
  content: finalContent,
  type: details.type,
  direction: finalDirection,
  source: "Life-OS",
  url: originalUrl  // 新增
});
```

---

## 🐛 修复的问题

| 问题 | 状态 | 说明 |
|------|------|------|
| 链接丢失 | ✅ 已修复 | AI生成内容中保留原始URL |
| 内容脑补 | ✅ 已修复 | Jina抓取全文后再AI提炼 |
| 格式混乱 | ✅ 已修复 | 统一使用Obsidian callout格式 |
| 文件覆盖 | ✅ 已修复 | 检查SHA，支持文件更新 |
| 网络错误 | ✅ 已修复 | 自动重试3次 |
| 错误提示 | ✅ 已修复 | 详细的错误分类和提示 |

---

## 📝 生成的Markdown文件格式

```yaml
---
title: "提炼后的标题"
date: 2026-02-07
type: "灵感"
source: "Life-OS"
status: "inbox"
direction: "AI"
url: "https://twitter.com/user/status/123456"
---

> [!info] 来源：Twitter/X
> https://twitter.com/user/status/123456

[抓取的内容...]

---
**原始输入**: [用户输入的内容]

AI提炼后的核心内容...

---
*Generated by Life-OS at 2026-02-07 14:30:00*
```

---

## 🚀 使用方法

1. **启动Life-OS**:
   ```bash
   cd projects/life-os-main
   npm run dev
   ```

2. **配置GitHub和AI**:
   - GitHub Token: 需要 `repo` 权限
   - AI API Key: OpenRouter (Gemini) 或 DeepSeek

3. **使用URL抓取**:
   - 在标题或内容中粘贴URL
   - 自动触发Jina抓取
   - AI自动提炼标题和核心观点
   - 推送到GitHub → Obsidian同步

---

## 📊 测试建议

### 基础功能测试
- [ ] 纯文本输入（无URL）
- [ ] 带URL的输入
- [ ] 多个URL的输入（只处理第一个）

### 平台测试
- [ ] Twitter/X链接
- [ ] 微信公众号链接
- [ ] 小红书链接
- [ ] 知乎链接
- [ ] 普通网页链接

### 边界情况测试
- [ ] Jina抓取失败的降级处理
- [ ] AI失败的URL保留
- [ ] 超长内容截断
- [ ] 网络错误重试
- [ ] GitHub Token权限不足

---

## 🔜 后续计划

### 短期 (本周)
- [ ] 添加批量URL处理
- [ ] 本地MCP服务集成（Playwright深度抓取）
- [ ] 图片下载功能

### 中期 (2周内)
- [ ] Firecrawl API集成（高质量抓取）
- [ ] 内容去重检测
- [ ] 历史记录查看

### 长期
- [ ] Web App部署
- [ ] 移动端优化
- [ ] 多用户支持

---

## 📚 相关文档

- [需求文档](./Life-OS-URL-抓取需求文档.md)
- [GitHub API文档](https://docs.github.com/en/rest)
- [Jina Reader](https://r.jina.ai/)
- [url-reader项目](https://github.com/yhslgg-arch/url-reader)

---

**维护者**: 小鲸 + 数字分身
**更新周期**: 按需更新
**反馈渠道**: GitHub Issues / 直接对话数字分身
